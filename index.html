<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VoidMarket ‚Äì Sign in</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  /* "Old web" / gammel portal-look for login-siden */

  body {
    margin: 0;
    background:
      repeating-linear-gradient(
        0deg,
        #05060a 0px,
        #05060a 1px,
        #060814 1px,
        #060814 2px
      );
    color: var(--text);
    font-family: "Verdana", system-ui, sans-serif;
  }

  .vm-auth-bg {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 18px;
  }

  .vm-auth-window {
    width: min(980px, 100%);
    border: 2px solid #3b4455;
    box-shadow: 0 0 0 1px #000, 0 0 22px rgba(0, 0, 0, 0.9);
    background: #04060d;
    color: var(--text);
  }

  /* Topp-linje ala gammel app/launcher */
  .vm-auth-topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 10px;
    background: linear-gradient(90deg, #101320, #1a2140);
    border-bottom: 1px solid #000;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
  }

  .vm-auth-topbar-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .vm-auth-logo {
    width: 28px;
    height: 28px;
    image-rendering: pixelated;
    border: 1px solid #000;
    background: #000;
  }

  .vm-auth-title-main {
    font-weight: 700;
  }

  .vm-auth-title-sub {
    opacity: 0.75;
  }

  .vm-auth-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
  }

  .vm-auth-led {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #16a34a;
    box-shadow: 0 0 6px #16a34a;
  }

  .vm-auth-led.off {
    background: #6b7280;
    box-shadow: none;
  }

  /* Hoved-layout */
  .vm-auth-inner {
    display: grid;
    grid-template-columns: 210px minmax(0, 1.5fr) 230px;
    gap: 0;
    border-top: 1px solid #202535;
    border-bottom: 1px solid #000;
  }

  @media (max-width: 840px) {
    .vm-auth-inner {
      grid-template-columns: minmax(0, 1.5fr);
    }
    .vm-auth-sidebar,
    .vm-auth-changelog {
      display: none;
    }
  }

  .vm-auth-panel {
    padding: 14px 14px 16px;
    background: radial-gradient(circle at top left, #141927 0%, #05060b 70%);
    border-right: 1px solid #000;
  }

  .vm-auth-panel.main {
    background: radial-gradient(circle at top, #141927 0%, #05060b 65%);
  }

  .vm-auth-panel:last-child {
    border-right: none;
  }

  /* Venstre: ‚Äúnav‚Äù / info */
  .vm-auth-sidebar h2 {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    margin: 0 0 8px;
    color: var(--muted);
  }

  .vm-auth-menu {
    list-style: none;
    padding: 0;
    margin: 0 0 12px;
    font-size: 12px;
  }

  .vm-auth-menu li {
    padding: 3px 0;
    color: var(--muted);
  }

  .vm-auth-menu span.tag {
    color: #22c55e;
    font-weight: 600;
    font-size: 10px;
    text-transform: uppercase;
    padding-left: 4px;
  }

  .vm-auth-counter {
    margin-top: 12px;
    font-size: 11px;
    color: var(--muted);
    border-top: 1px dashed #283141;
    padding-top: 8px;
  }

  .vm-auth-counter code {
    background: #02030a;
    border: 1px solid #111827;
    padding: 1px 4px;
    font-size: 10px;
  }

  /* Midten: selve login-formen */
  .vm-auth-heading {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 2px;
    letter-spacing: 0.08em;
  }

  .vm-auth-subline {
    margin: 0 0 10px;
    font-size: 11px;
    color: var(--muted);
  }

  .vm-auth-subline small {
    opacity: 0.7;
  }

  .vm-auth-subline a {
    color: #a5b4fc;
    text-decoration: underline;
  }

  .vm-auth-subline a:hover {
    text-decoration: none;
    opacity: 0.9;
  }

  .vm-auth-form-wrapper {
    margin-top: 8px;
    border: 1px solid #2b3244;
    background: #050711;
    box-shadow: inset 0 0 0 1px #020308;
  }

    .vm-auth-discord {
    margin-top: 10px;
    padding: 8px 10px;
    border-radius: 4px;
    border: 1px dashed #374151;
    background: #050814;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    font-size: 11px;
    color: var(--muted);
  }

  .vm-auth-discord-text {
    max-width: 70%;
  }

  .vm-auth-discord-label {
    font-family: "SF Mono", Menlo, Monaco, Consolas, "Courier New", monospace;
    font-size: 10px;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    color: #9ca3af;
    margin-bottom: 2px;
  }

  .vm-auth-discord .btn.discord {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 6px 12px;
    border-radius: 999px;
    background: linear-gradient(135deg, #5865f2, #4c1d95);
    border: 1px solid #818cf8;
    color: #f9fafb;
    white-space: nowrap;
  }

  .vm-auth-discord .btn.discord:hover {
    opacity: 0.95;
  }

  .vm-auth-form-header {
    padding: 6px 10px;
    background: linear-gradient(90deg, #0b1020, #111827);
    border-bottom: 1px solid #1f2937;
    font-size: 11px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .vm-auth-form-header span {
    opacity: 0.8;
  }

  .vm-auth-form-inner {
    padding: 10px 10px 12px;
  }

  /* ‚ÄúOld‚Äù table-form layout */
  .vm-auth-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }

  .vm-auth-table th,
  .vm-auth-table td {
    padding: 4px 4px;
    vertical-align: middle;
  }

  .vm-auth-table th {
    width: 38%;
    text-align: right;
    padding-right: 8px;
    color: var(--muted);
    font-weight: 500;
    white-space: nowrap;
  }

  .vm-auth-table label {
    cursor: pointer;
  }

  .vm-auth-table input {
    width: 100%;
    font-size: 12px;
    padding: 4px 6px;
    background: #02040b;
    border: 1px solid #4b5563;
    color: var(--text);
    outline: none;
  }

  .vm-auth-table input:focus {
    border-color: #a855f7;
    box-shadow: 0 0 0 1px #a855f7;
  }

  .vm-auth-err {
    margin-top: 4px;
    min-height: 16px;
    font-size: 11px;
    color: #fca5a5;
  }

  .vm-auth-actions {
    margin-top: 8px;
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    align-items: center;
  }

  /* Override buttons inne p√• login-siden for mer ‚Äúold‚Äù stil */
  .vm-auth-form-inner .btn {
    border-radius: 2px;
    font-size: 11px;
    padding: 6px 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .vm-auth-form-inner .btn.primary {
    background: linear-gradient(180deg, #16a34a, #065f46);
  }

  .vm-auth-form-inner .btn.accent {
    background: linear-gradient(180deg, #4f46e5, #312e81);
  }

  .vm-auth-hint {
    margin-top: 8px;
    font-size: 11px;
    color: var(--muted);
  }

  /* H√∏yre: changelog / ‚Äúbeen around a while‚Äù */
  .vm-auth-changelog-title {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    margin: 0 0 8px;
    color: var(--muted);
  }

  .vm-auth-changelog {
    font-size: 11px;
  }

  .vm-auth-changelog ul {
    list-style: square;
    padding-left: 16px;
    margin: 0 0 8px;
  }

  .vm-auth-changelog li {
    margin-bottom: 4px;
    color: var(--muted);
  }

  .vm-auth-changelog .ver {
    color: #a5b4fc;
    font-weight: 600;
  }

  .vm-auth-footer-strip {
    padding: 4px 8px;
    font-size: 10px;
    color: var(--muted);
    background: #020308;
    border-top: 1px solid #000;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .vm-auth-footer-strip span {
    opacity: 0.8;
  }
</style>


</head>
<body>

  <div class="vm-auth-bg">
    <div class="vm-auth-window">

      <!-- Topplinje / gammel launcher-f√∏lelse -->
      <div class="vm-auth-topbar">
        <div class="vm-auth-topbar-left">
          <img src="assets/boxes/beta/bta-sko.png" alt="VoidMarket" class="vm-auth-logo" />
          <div>
            <div class="vm-auth-title-main">VOIDMARKET ACCOUNT GATEWAY</div>
            <div class="vm-auth-title-sub">v1.2.3 ¬∑ voidmarket Online*</div>
          </div>
        </div>

        <div class="vm-auth-status">
          <div class="vm-auth-led"></div>
          <span>SERVER STATUS: ONLINE</span>
        </div>
      </div>

      <!-- Tre-delt layout: fake-nav ¬∑ login ¬∑ changelog -->
      <div class="vm-auth-inner">
        <!-- VENSTRE: ‚Äúold web‚Äù-sidebar -->
        <aside class="vm-auth-panel vm-auth-sidebar">
          <h2>VOIDMARKET // HUB</h2>
          <ul class="vm-auth-menu">
            <li>&gt; Home <span class="tag">beta</span></li>
           <!-- <li>&gt; Market overview</li>-->
           <!-- <li>&gt; Item gallery</li>-->
           <!-- <li>&gt; Global feed</li>-->
           <!-- <li>&gt; Support / FAQ</li>-->
          </ul>

          <div class="vm-auth-counter">
            <div>Last update: <code>30-11-2025</code></div>
            <div>Current version <code>1.2.3</code></div>
            <div>Best viewed in <code>1080x1920</code></div>
            <p class="vm-auth-subline">
              <br>
                Open our home page?
                <a href="home.html" target="_blank" rel="noopener noreferrer">
                  VoidMarket Home Page
                </a>

              <br>
              <br>
              <small>
                No account yet? Join our 
                <a href="https://discord.gg/MJDUbEBWuc" target="_blank" rel="noopener noreferrer">
                  Discord server
                </a>
                to request access.
              </small>
            </p>
          </div>
        </aside>

        <!-- MIDTEN: selve login-skjermen -->
        <main class="vm-auth-panel main">
          <h1 class="vm-auth-heading">VOIDMARKET PORTAL</h1>
          <p class="vm-auth-subline">
            Use your account to open boxes, collect art and trade with friends.<br />
            <small>New here? Join our discord and get an account from our team!</small>
          </p>

          <div class="vm-auth-form-wrapper">
            <div class="vm-auth-form-header">
              <span>Account credentials</span>
              <span>v1 cloud auth ¬∑ Supabase</span>
            </div>

            <div class="vm-auth-form-inner">
              <form id="authForm" autocomplete="off">
                <table class="vm-auth-table">
                  <tr id="usernameRow" style="display: none;">
                    <th>
                      <label for="username">Display name</label>
                    </th>
                    <td>
                      <input
                        id="username"
                        name="username"
                        minlength="3"
                        maxlength="24"
                        placeholder="(optional on first login)"
                      />
                    </td>
                  </tr>
                  <tr>
                    <th>
                      <label for="email">Email</label>
                    </th>
                    <td>
                      <input
                        id="email"
                        name="email"
                        type="email"
                        required
                        placeholder="you@example.com"
                      />
                    </td>
                  </tr>
                  <tr>
                    <th>
                      <label for="password">Password</label>
                    </th>
                    <td>
                      <input
                        id="password"
                        name="password"
                        type="password"
                        required
                        minlength="6"
                        maxlength="64"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      />
                    </td>
                  </tr>
                </table>

                <div class="vm-auth-err" id="authErr"></div>

                <div class="vm-auth-actions">
                  <button type="button" id="loginBtn" class="btn primary">Sign in</button>
                  <button type="button" id="signupBtn" class="btn accent">Create account</button>
                </div>

                <div class="vm-auth-hint">
                  problems with login? Join our discord and speak with the Voidmarket Team directly!
                </div>
              </form>
            </div>
          </div>

          <div class="vm-auth-discord">
            <div class="vm-auth-discord-text">
              <div class="vm-auth-discord-label">// ACCESS REQUEST</div>
              <div>
                New players request accounts through our Discord.  
                Join the server to read how to get started.
              </div>
            </div>
            <a href="https://discord.gg/MJDUbEBWuc" 
               target="_blank" 
               rel="noopener noreferrer"
               class="btn discord">
              Join Discord
            </a>
          </div>


        </main>

        <!-- CHANGELOG, UPDATES,  -->
        <aside class="vm-auth-panel vm-auth-changelog">
          <h2 class="vm-auth-changelog-title">CHANGELOG (ARCHIVE)</h2>
          <div class="vm-auth-changelog">
            <ul>
              <li>
                <span class="ver">v1.2.3 ¬∑ 30-11-2025</span><br/>
                - Featured Box added (market) <br>
                - Player auction added <br>
                - Banners left/right <br>
                - Fisherman25 Box added <br>
                - Xmas 25 event started <br>
                - Removed username input on login <br>
                - Added 2 achievements <br>
                - Added 2 titles <br>
              </li>
              <li>
                <span class="ver">v1.2.2 ¬∑ 23-11-2025</span><br/>
                - New Interface design <br>
                - Profile titles added <br>
                - Draggable Global feed added <br>
                - Player search (look-up) added
              </li>
              <li>
                <span class="ver">v1.2 ¬∑ 19-11-2025</span><br/>
                Accounts in cloud (Access anywhere). <br>
                Account deletion request added. <br>
                "VoidMarket" logo name changed to "VoidMarket BETA"
              </li>
              <li>
                <span class="ver">HALLOWEEN EVENT ¬∑ <br>
                  09-11-2025 -> 31-12-25</span><br/>
                Added HW 2025 box.<br>
              </li>
            </ul>

            <p style="margin-top: 6px; color: var(--muted); font-size: 10px;">
              *Rumour says early testers still hold items that never dropped again‚Ä¶
            </p>
          </div>
        </aside>
      </div>

      <!-- Bunnstripe -->
      <div class="vm-auth-footer-strip">
        <span>2025 VoidMarket ¬∑ Built by collectors, for collectors</span>
        <span>Powered by Supabase</span>
      </div>
    </div>
  </div>

  <script>
    // ---- Supabase Auth (cloud) ----
    const SESSION_KEY = "vm_session_v1";

    const SUPABASE_URL = "https://vsasxahjavdstcrcsghg.supabase.co"; 
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzYXN4YWhqYXZkc3RjcmNzZ2hnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNDI4MzgsImV4cCI6MjA3ODgxODgzOH0.g3DF07JppjF19-7FT7wNk--Ns7wbC83jcC-eZtjoiGs";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function showError(msg){
      document.getElementById("authErr").textContent = msg || "";
    }

    function setSession(username, userId){
      localStorage.setItem(SESSION_KEY, JSON.stringify({
        username,
        userId,
        loginAt: Date.now()
      }));
    }

    // Henter felt fra form
    function getAuthInputs() {
      const username = document.getElementById("username").value.trim();
      const email    = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      return { username, email, password };
    }

    async function isUsernameTaken(username){
      const name = (username || "").trim();
      if (!name) return false;

      try {
        const { data, error } = await supabaseClient
          .from("profiles")
          .select("id")
          .ilike("username", name)  // case-insensitive
          .limit(1);

        if (error) {
          console.error("username check error:", error);
          // fail-open: ikke blokker registrering hvis sjekken feiler
          return false;
        }
        return Array.isArray(data) && data.length > 0;
      } catch (e) {
        console.error("username check exception:", e);
        return false;
      }
    }


    // Kun brukt ved registrering / f√∏rste innlogging
    async function createProfileAndSave(userId, username, email) {
      // 1) Opprett profil (forventer at den ikke finnes fra f√∏r)
      const { error: profErr } = await supabaseClient
        .from("profiles")
        .insert({
          id: userId,
          username: username || null,
          email: email || null
        });

      if (profErr) {
        console.error("profiles insert error", profErr);
        throw profErr;
      }

      // 2) Opprett tom save
      const { error: saveErr } = await supabaseClient
        .from("saves")
        .insert({
          user_id: userId,
          coins: 0,
          inventory: {},
          achievements: {},
          featured_slots: []
        });

      if (saveErr) {
        console.error("saves insert error", saveErr);
        throw saveErr;
      }
    }

    // S√∏rger for at det finnes en save-rad (brukes ved login)
    async function ensureSaveRow(userId) {
      const { data: saveRow, error: sErr } = await supabaseClient
        .from("saves")
        .select("id")
        .eq("user_id", userId)
        .maybeSingle();

      if (sErr) {
        console.error("saves lookup error", sErr);
        return;
      }

      if (!saveRow) {
        const { error: saveInsertErr } = await supabaseClient
          .from("saves")
          .insert({
            user_id: userId,
            coins: 0,
            inventory: {},
            achievements: {},
            featured_slots: []
          });
        if (saveInsertErr) {
          console.error("saves insert error", saveInsertErr);
        }
      }
    }

    // ---------- LOGIN ----------
    async function handleLogin(){
      showError("");

      const { username, email, password } = getAuthInputs();

      if (!email || !password) {
        return showError("Enter email and password.");
      }

      const { data, error } = await supabaseClient.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        console.error(error);
        if (error.message.includes("Invalid login credentials")) {
          return showError("Incorrect email or password.");
        }
        if (error.message.includes("Email not confirmed")) {
          return showError("Please confirm your email first.");
        }
        return showError(error.message || "Could not sign in. Try again.");
      }

      const user = data.user;
      if (!user) {
        return showError("Login succeeded, but no user returned.");
      }

      let displayName = email;

      // 1) Hent profil (inkl. approved)
      try {
        const { data: prof, error: profErr } = await supabaseClient
          .from("profiles")
          .select("username, approved")
          .eq("id", user.id)
          .maybeSingle();

        if (profErr) {
          console.error("profile fetch error", profErr);
          await supabaseClient.auth.signOut();
          return showError("Could not load profile. Try again later.");
        }

        // üîí IKKE GODKJENT ‚Üí STOPP HER
        if (prof && prof.approved === false) {
          await supabaseClient.auth.signOut();
          return showError(
            "Your account is pending approval.\n" +
            "Join our Discord and tell us your username."
          );
        }

        if (!prof) {
          // F√∏rste login ‚Üí opprett profil (approved = false som default)
          const metaName = user?.user_metadata?.username;
          const initialName =
            (metaName && String(metaName).trim().length >= 3) ? String(metaName).trim()
            : (username && username.length >= 3) ? username
            : email;

          try {
            await createProfileAndSave(user.id, initialName, email);
          } catch (e) {
            console.error("createProfileAndSave on login error", e);
            await supabaseClient.auth.signOut();
            return showError("Could not create profile. Try again later.");
          }

          // Ny bruker er ikke godkjent enda
          await supabaseClient.auth.signOut();
          return showError(
            "Your account is pending approval.\n" +
            "Join our Discord and tell us your username."
          );
        }

        // Profil finnes og er godkjent
        if (prof.username) {
          displayName = prof.username;
        }

      } catch (e) {
        console.error("profile fetch exception", e);
        await supabaseClient.auth.signOut();
        return showError("Unexpected error loading profile.");
      }

      // 2) S√∏rg for at save-rad finnes (kun godkjente brukere kommer hit)
      await ensureSaveRow(user.id);

      // 3) Lag session og g√• til spillet
      setSession(displayName, user.id);
      window.location.href = "voidmarket.html";
    }


    document.getElementById("loginBtn").addEventListener("click", handleLogin);

    // Hvis session allerede finnes lokalt ‚Üí hopp rett inn i spillet
    (function autoRedirectIfLoggedIn(){
      try{
        const sess = JSON.parse(localStorage.getItem(SESSION_KEY));
        if(sess?.username && sess?.userId){
          window.location.href = "voidmarket.html";
        }
      }catch{}
    })();


    let authMode = "login"; // "login" | "signup"

    function setAuthMode(mode){
      authMode = mode;
      const row = document.getElementById("usernameRow");
      const userInput = document.getElementById("username");
      const hint = document.querySelector(".vm-auth-hint");

      if (mode === "signup"){
        if (row) row.style.display = "";
        if (hint) hint.textContent = "Create an account. You'll receive a verification email before you can sign in.";
        if (userInput) userInput.placeholder = "Display name (3‚Äì24 chars)";
      } else {
        if (row) row.style.display = "none";
        if (hint) hint.textContent = "Problems with login? Join our discord and speak with the Voidmarket Team directly!";
      }
    }

    async function handleSignup(){
      showError("");

      const { username, email, password } = getAuthInputs();

      if (!username || username.length < 3) {
        return showError("Please choose a display name (min 3 chars).");
      }
      if (!email || !password) {
        return showError("Enter email and password.");
      }

      // Sjekk om display name er tatt (profiles-lookup)
      const taken = await isUsernameTaken(username);
      if (taken) return showError("That display name is already taken.");

      // Lag bruker + legg display name i user_metadata
      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          data: { username }, // user_metadata
          // optional: redirectTo: "https://dittdomene.no/index.html"
        }
      });

      if (error) {
        console.error("signUp error:", error);
        return showError(error.message || "Could not create account.");
      }

      // Supabase sender verification mail n√•r email confirmations er enabled
      // data.user kan v√¶re null i noen flows, men dette er ok.
      showError("Account created! Join our discord and follow the next steps to verify account!");
      setAuthMode("login");
    }

    document.getElementById("loginBtn")?.addEventListener("click", () => {
      // alltid login-mode n√•r man trykker Sign in
      setAuthMode("login");
      handleLogin();
    });

    document.getElementById("signupBtn")?.addEventListener("click", () => {
      // bytter til signup-mode f√∏rste klikk; andre klikk gj√∏r signup
      if (authMode !== "signup") {
        setAuthMode("signup");
        return;
      }
      handleSignup();
    });

    // Start i login-mode
    setAuthMode("login");


  </script>
</body>
</html>


</body>
</html>
